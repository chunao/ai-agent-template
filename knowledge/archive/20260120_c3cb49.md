# 【個人開発】未経験が、Google推奨のベストプラクティスで「最強のCI/CD」を構築してみた🏰

> [!NOTE]
> Captured: 2026-01-20
> Source: [https://zenn.dev/miki_mini/articles/c3cb49f45dcc8e](https://zenn.dev/miki_mini/articles/c3cb49f45dcc8e)

## TL;DR & Key Conclusions
個人開発のLINE Botなどのプロジェクトにおいて、Google Cloudが推奨するベストプラクティス（Workload Identity Federation、Secret Manager、Artifact Registry、Trivyなど）を用いて、セキュリティと信頼性の高いCI/CDパイプラインを構築する手法を解説した記事。
「動けばいい」から「安心して運用できる」状態への移行ガイドとして有用。

- **セキュリティのシフトレフト**: GitHub Actions内で`Trivy`を用いた脆弱性スキャンを行い、ビルド前にセキュリティリスクを検知・排除する。
- **キーレス認証 (WIF)**: サービスアカウントキー（JSON）の発行と管理をやめ、Workload Identity Federationを使用してGitHub ActionsからGoogle Cloudへ安全に認証する。
- **脱.envファイル**: 環境変数をファイルで管理せず、Secret Managerに集約し、Cloud Runなどの実行環境に安全に注入（Secret Injection）する。
- **テスト可能な設計 (DI)**: 外部API（LINE, Weatherなど）への依存をDependency Injectionパターンで切り離し、モックを用いた単体テストを容易にすることで、テストカバレッジを高める。
- **コストと運用の最適化**: Container RegistryではなくArtifact Registryを使用し、古いイメージの自動削除ポリシーを設定してコストを抑制する。

## Quickstart
Google Cloud上でセキュアなパイプラインを構築するステップ：

1.  **Artifact Registry作成**:
    - `gcloud artifacts repositories create ...` でDockerリポジトリを作成（Container Registryは非推奨）。
2.  **認証設定 (WIF)**:
    - Workload Identity Pool と Provider を作成。
    - サービスアカウントに `roles/iam.workloadIdentityUser` を付与し、GitHubリポジトリと紐付ける。
3.  **シークレット管理**:
    - Secret Manager にAPIキーなどを登録。
    - Cloud Run 実行用サービスアカウントに `roles/secretmanager.secretAccessor` を付与。
4.  **GitHub Actions**:
    - Workflowファイルを作成し、`google-github-actions/auth` でWIF認証を行う。
    - `aquasecurity/trivy-action` でスキャンし、`pytest` でテストを実行した後、ビルド・デプロイを行う。
5.  **デプロイ**:
    - `gcloud run deploy ... --set-secrets` でシークレットを環境変数としてマウントする。

## Context & Claims
### Claims (主張)
- **「希望」は戦略ではない**: 手動デプロイによるミスを祈るのではなく、自動化で排除すべき。
- **ハードコードされた秘密情報の排除**: `.env` やコード内のトークンは漏洩リスクの温床であるため、マネージドなシークレット管理へ移行すべき。
- **テストはバグを防ぐためにある**: 依存性の注入を活用し、外部サービスに依存しない「Hermetic Testing（密閉されたテスト）」を行うことで、開発の安心感と速度が向上する。

### Evidence (根拠)
- Google Cloud 公式ドキュメントおよび ”Software Engineering at Google” の記述。
- Container Registry の廃止推奨と Artifact Registry への移行ガイダンス。
- WIFを利用することで、永続的なクレデンシャルを持たずに済むセキュリティ上の利点。

### Caveats (注意点)
- **初期設定のコスト**: WIFやIAM、Secret Managerの設定は、単に`.env`を置くより初期学習と設定の手間がかかる。
- **IAM権限の厳密さ**: `secretAccessor` や `artifactregistry.writer` など、最小権限の原則に従うと、権限不足でパイプラインが落ちることがある（トラブルシューティングが必要）。

## Normalized Conditions

| 項目 | 内容 |
| :--- | :--- |
| **Use Cases** | ・個人〜小規模チーム開発で、セキュリティを妥協せず本格的なCI/CDを組みたい場合<br>・Python + Cloud Run構成のアプリケーション<br>・`.env`管理に限界や不安を感じているプロジェクト |
| **Anti-Cases** | ・完全な静的サイト（Cloud Pages/Netlify等で十分な場合）<br>・使い捨てのプロトタイプで、設定時間を極限まで削りたい場合<br>・Google Cloud以外のプラットフォーム（AWS/Azure）をメインとしている場合（概念は通じるがツールが異なる） |
| **Prerequisites** | ・Google Cloud Projectの課金有効化<br>・Dockerおよびコンテナ技術の基礎知識<br>・GitHub Actionsの基本理解<br>・Python (または任意の言語) のテストコード作成スキル |
| **Decision Triggers** | ・「サービスアカウントキーの管理が怖い/面倒」と感じた時<br>・本番環境で「環境変数の設定ミス」による障害が発生した時<br>・テストカバレッジを向上させたいが、外部API依存でテストが書きにくいと感じた時 |
| **Failure Modes** | ・**IAM設定ミス**: サービスアカウントに必要な権限（Artifact Registry書き込み、Secret Manager参照）が不足しているとCI/CDが失敗する。<br>・**WIF設定ミス**: Providerの属性マッピングやSubjectの指定ミスにより認証が通らない。 |
| **Operational Cost** | ・Secret Manager: アクセス頻度によるが少額（月額数百円程度〜無料枠内）<br>・Artifact Registry: ストレージ容量課金（不要イメージ削除ポリシーで抑制可能）<br>・Cloud Run: 使用量に応じた従量課金 |
