# /tdd - TDDサイクル実行

TDD (Test-Driven Development) サイクルを実行します。

## 引数

- `--no-auto`: TDDサイクル完了後の自動処理（issue-sync, review）をスキップ

## 引数解析

TDDサイクル開始前に、`$ARGUMENTS` に `--no-auto` が含まれているか確認してください。
含まれている場合は、TDDサイクル完了後の自動処理をスキップします。

## 手順

### 1. RED - テストを書く

まず失敗するテストを書いてください：

- 実装したい機能の仕様を明確にする
- その仕様を検証するテストコードを作成
- テストが失敗することを確認

### 2. REVIEW - テスト項目の妥当性評価

作成したテストの「質」を評価してください。Progressive Pattern により、1観点ずつ集中して評価します。

#### 評価観点（5ステップ）

| Step | 観点 | 配点 | チェック内容 |
|------|------|------|-------------|
| 1 | 正常系 | 20点 | 基本的な成功パス、主要ユースケースのカバー |
| 2 | 異常系 | 20点 | エラー入力、例外ハンドリングのテスト |
| 3 | 境界値 | 20点 | 最小/最大値、空/null、境界条件のテスト |
| 4 | 要件対応 | 20点 | ビジネス要件・受け入れ基準との対応 |
| 5 | 品質特性 | 20点 | リファクタリング耐性、保守性、意図の明確さ |

> ⚠️ 各ステップは**1つの観点だけに集中**して評価してください。
> 詳細なチェック項目は `tdd-cycle` SKILL（`.claude/skills/tdd-cycle/SKILL.md`）を参照してください。

#### 判定基準（80点ルール）

| 総合スコア | 判定 | アクション |
|-----------|------|-----------|
| **80点以上** | ✅ PASS | GREEN Phase へ進む |
| **60-79点** | ⚠️ 要改善 | 不足しているテストを追加し、再評価 |
| **60点未満** | ❌ 要見直し | テスト設計を根本から見直す |

### 3. GREEN - 最小限の実装

テストを通す最小限のコードを書いてください：

- テストを通すことだけに集中
- 余計な機能は追加しない
- すべてのテストがパスすることを確認

### 4. REFACTOR - リファクタリング

コードを改善してください：

- 重複を排除
- 命名を改善
- 構造を整理
- テストが引き続きパスすることを確認

## 注意事項

- 各フェーズを必ず順番に実行すること（RED → REVIEW → GREEN → REFACTOR）
- REVIEWフェーズで80点未満の場合はテストを改善してから次へ進むこと
- REFACTORフェーズでは機能追加をしないこと
- テストカバレッジ80%以上を目標とすること

---

## TDDサイクル完了後の自動処理

TDDサイクル（RED → REVIEW → GREEN → REFACTOR）が完了したら、以下の自動処理を実行してください。

> **注意**: `--no-auto` オプションが指定されている場合は、このセクションをスキップしてください。

### Step 1: Issue番号の特定

会話のコンテキストからIssue番号を特定してください。以下の優先順位で取得します：

1. 会話中で `/start-issue XX` が実行された場合、そのIssue番号を使用
2. 会話中でIssue番号が明示的に言及されている場合、それを使用
3. （フォールバック）上記で特定できない場合のみ、ブランチ名から抽出：

```bash
# ブランチ名を取得
BRANCH=$(git branch --show-current)

# Issue番号を抽出（例: feature/issue-18-xxx → 18）
ISSUE_NUM=$(echo "$BRANCH" | grep -oE 'issue-[0-9]+' | grep -oE '[0-9]+')

# 抽出結果を確認
echo "Issue番号: $ISSUE_NUM"
```

- Issue番号が特定できた場合 → Step 2 へ進む
- Issue番号が特定できない場合 → 「Issue番号を自動特定できませんでした。手動で `/issue-sync {番号}` を実行してください。」と案内して自動処理を終了

### Step 2: TDD完了報告をIssueに投稿

TDDサイクルの完了報告をIssueにコメントとして投稿します：

```bash
gh issue comment $ISSUE_NUM --body "$(cat <<'EOF'
## TDDサイクル完了報告 - {日時}

### 実装内容
- {実装した機能の概要}

### テスト結果
- テストケース数: {N}
- 成功: {N}/{N}
- カバレッジ: {X}%

### 変更ファイル
- {変更したファイル1}
- {変更したファイル2}

### 次のステップ
- コードレビューを実行中...
EOF
)"
```

### Step 3: コードレビューを実行

`/review` スキルを呼び出してコードレビューを実行してください。

> **重要**: `/review` は80点以上の場合、自動的にレビュー結果をIssueに投稿します（PR#25で実装済み）。そのため、レビュー後の `/issue-sync` は不要です。

### 自動処理フロー図

```
TDDサイクル完了（RED → REVIEW → GREEN → REFACTOR）
  ↓
Issue番号特定（会話コンテキスト優先 → ブランチ名フォールバック）
  ↓
TDD完了報告をIssueに投稿
  ↓
/review 実行
  ↓ （80点以上の場合）
レビュー結果をIssueに自動投稿（/review の既存機能）
```

### 自動処理が失敗した場合

| 失敗箇所 | 対処方法 |
|---------|---------|
| Issue番号特定失敗（コンテキスト・ブランチ名とも） | 手動で `/issue-sync {番号}` を実行 |
| Issue投稿失敗 | GitHub CLIの認証状態を確認し、手動で投稿 |
| レビュー80点未満 | 指摘事項を修正後、再度 `/tdd` を実行 |
