# レビューステップ追加ガイドライン

新しいレビューステップをワークフローに追加する際の判断基準です。

## モデル選択基準

新しいレビュータスクに対して、以下の判断軸でモデルを選択してください。

### 判断フロー

```
1. タスクの複雑度を評価
   ├─ チェックリスト的評価（基準が明確） → Haiku候補
   ├─ コード理解が必要（意図・構造の把握） → Sonnet候補
   └─ アーキテクチャ判断（全体設計の評価） → Sonnet/Opus候補

2. 必要コンテキスト量を評価
   ├─ 単一ファイル / 限定的な差分 → Haiku で十分
   ├─ 複数ファイル / モジュール間連携 → Sonnet 推奨
   └─ プロジェクト全体 / 設計方針 → Sonnet/Opus 推奨

3. コスト感度を考慮
   ├─ 高頻度実行（TDDサイクル内等） → Haiku 優先
   ├─ 中頻度実行（PR単位等） → Sonnet でバランス
   └─ 低頻度実行（重要判断等） → Opus も許容
```

### モデル選択マトリクス

| タスク複雑度 | コンテキスト量 | 実行頻度 | 推奨モデル |
|------------|--------------|---------|-----------|
| 低（チェックリスト） | 少（単一ファイル） | 高 | Haiku |
| 低 | 中 | 中 | Haiku/Sonnet |
| 中（コード理解） | 少 | 高 | Sonnet |
| 中 | 中 | 中 | Sonnet |
| 高（設計判断） | 多（プロジェクト全体） | 低 | Sonnet/Opus |

## 現在のレビュー体制

| フェーズ | ファイル | 推奨モデル | 複雑度 | コンテキスト |
|---------|---------|-----------|--------|------------|
| 計画レビュー | `agents/plan-reviewer.md` | Sonnet | 中〜高 | プロジェクト全体 |
| TDD REVIEW | `skills/tdd-cycle/SKILL.md` | Haiku | 低〜中 | テストファイル限定 |
| コードレビュー(詳細) | `skills/progressive-review/SKILL.md` | Sonnet | 高 | コード全体 |
| コードレビュー(軽量) | `agents/reviewer.md` | Sonnet | 中 | 変更差分 |

## ロール定義テンプレート

新しいレビューステップを追加する際は、以下のテンプレートに従ってロールを定義してください。

```markdown
## Role

{レビュアーの役割を1-2文で説明}

## Capabilities

- {能力1}
- {能力2}

## Review Process

### 1. {対象の理解}
{レビュー対象の把握手順}

### 2. {評価観点}
{具体的なチェック項目}

### 3. フィードバック
{結果報告フォーマット}

## Model Recommendation

| 項目 | 内容 |
|------|------|
| **推奨モデル** | {Haiku/Sonnet/Opus} |
| **代替候補** | {代替モデルと条件} |
| **タスク複雑度** | {低/中/高} |
| **必要コンテキスト** | {必要なコンテキストの範囲} |

### 根拠
- {推奨モデルを選んだ理由1}
- {推奨モデルを選んだ理由2}
- Codex委任可能性: {高/中/低} - {理由}
```

## Codex委任（Issue #45 実装済み）

レビュータスクをCodex CLI（OpenAI）に委任し、Claude Codeのトークン消費を削減する仕組みです。
詳細は `.claude/skills/codex-delegate/SKILL.md` を参照してください。

### 運用方針

- **優先**: 全レビュータスクでCodex委任を使用する
- **フォールバック**: Codex CLI利用不可時はClaude Codeで従来通り実行
- **方式**: ローカルSkill方式（全レビュータイミングで統一的に使用可能）

### 委任可能性の評価軸

| 評価軸 | 委任しやすい | 委任しにくい |
|--------|------------|------------|
| タスクの独立性 | 独立した評価タスク | 対話的・反復的な作業 |
| コンテキスト量 | 限定的（ファイル単位） | 広範（プロジェクト全体） |
| 評価基準 | 明確・定量的 | 曖昧・定性的 |
| フォーマット | 構造化された出力 | 自由形式の判断 |

### 現在の委任適性評価

| レビュータスク | 委任可能性 | 実装状態 | 根拠 |
|--------------|-----------|---------|------|
| TDD REVIEW | 高 | ✅ 実装済み | 評価基準が明確、コンテキスト限定的、定量的判断 |
| コードレビュー(reviewer.md) | 高 | ✅ 実装済み | 独立した評価タスク、変更差分に限定 |
| コードレビュー(progressive-review) | 高 | ✅ 実装済み | 独立した評価タスク、明確な評価基準、git diff出力で十分 |
| 計画レビュー | 中 | ✅ 実装済み | Issue内容に計画が一元化されているため、Issue取得でコンテキスト提供可能 |

### Codex委任時のコンテキスト提供方法

| レビュータスク | コンテキストソース |
|--------------|----------------|
| TDD REVIEW | Issue内容 + テストファイル + 実装ファイル |
| 計画レビュー | Issue内容（計画はIssueコメントに記載） |
| コードレビュー(reviewer.md) | Issue内容 + git diff出力 |
| コードレビュー(progressive-review) | Issue内容 + git diff main...HEAD出力 |

## 新規レビューステップ追加時のチェックリスト

新しいレビューステップを追加する際は、以下を確認してください：

- [ ] ロール定義テンプレートに従って定義されているか
- [ ] Model Recommendation セクションが根拠付きで記述されているか
- [ ] 既存のレビューステップとの重複がないか確認したか
- [ ] 既存のレビューステップとの評価観点の役割分担が明確か
- [ ] Codex委任可能性が評価されているか
- [ ] 評価基準（スコアリング）が明確に定義されているか
- [ ] 80点ルールに基づくパス/フェイル基準が設定されているか
