---
name: codex-delegate
description: |
  レビュータスクをCodex CLIに委任して実行する。Claude Codeのトークン消費を削減し、レートリミット対策として機能する。
  トリガー: "codexに委任", "codex delegate", "codexでレビュー"
---

# Codex Delegate Skill

## Overview

レビュータスクをCodex CLI（OpenAI）に委任し、Claude Codeのトークン消費を削減するSkillです。
全レビュータイミング（未コミット段階含む）で統一的に使用可能です。

## Prerequisites

- Codex CLIがインストール済みであること（`npm install -g @openai/codex`）
- `OPENAI_API_KEY` 環境変数が設定されていること

## Invocation Interface

### パラメータ

| パラメータ | 必須 | 説明 |
|-----------|------|------|
| レビュータイプ | ✅ | `tdd-review` / `plan-review` / `code-review` / `progressive-review` |
| 対象ファイル | ✅ | レビュー対象ファイルパス（複数指定可） |
| Issue番号 | △ | コンテキスト取得用（省略時はIssue取得をスキップ） |

### 戻り値

既存フォーマットに準拠したMarkdown形式のレビュー結果

---

## Execution Flow

### Step 1: フォールバック判定

Codex CLIの存在を確認します。

```bash
# Windows
where codex 2>nul

# macOS/Linux
which codex 2>/dev/null
```

- **見つかった場合** → Step 2 へ進む
- **見つからない場合** → フォールバック（後述）

### Step 2: コンテキスト収集

#### 2a. Issue内容の取得（Issue番号が指定されている場合）

```bash
gh issue view {issue番号} --comments
```

取得した内容をプロンプトの「コンテキスト」セクションに埋め込みます。

#### 2b. 対象ファイルの特定

レビュータイプに応じて対象を特定：

| レビュータイプ | 対象の特定方法 |
|--------------|--------------|
| `tdd-review` | 指定されたテストファイル + 対応する実装ファイル |
| `plan-review` | Issue内容（計画はIssueコメントに記載） |
| `code-review` | `git diff` 出力（未コミット変更）または `git diff HEAD~1`（最新コミット） |
| `progressive-review` | `git diff main...HEAD` 出力（ブランチ全体の変更） |

### Step 3: プロンプト組み立て

以下の構造でプロンプトを組み立てます：

```
[ロール定義（評価基準・チェックリスト）]
+
[コンテキスト（Issue内容）]
+
[対象ファイル/差分の指定]
+
[出力フォーマット指定]
```

各レビュータイプのプロンプトテンプレートは後続セクションに定義。

### Step 4: Codex CLI実行

```bash
codex exec --full-auto --sandbox read-only --cd "{project_directory}" "{組み立てたプロンプト}"
```

### Step 5: 結果返却

Codexの出力をそのまま返却します（既存フォーマットに準拠した出力を指示済み）。

---

## Fallback（フォールバック）

以下の場合、Claude Codeで従来通りレビューを実行します：

1. Codex CLIがインストールされていない
2. `OPENAI_API_KEY` が設定されていない
3. Codex CLI実行がエラーで失敗した

フォールバック時の動作：
- 警告メッセージを表示: 「Codex CLIが利用できないため、Claude Codeで実行します」
- 対応するレビュースキル/エージェントの従来手順で実行

---

## Prompt Templates

### tdd-review（TDD テスト品質レビュー）

```
あなたはテスト品質レビューの専門家です。以下のテストコードを評価してください。

## 評価基準（5ステップ）

各ステップは1つの観点だけに集中して評価してください。

### Step 1: 正常系チェック（20点）
- 基本的な成功パスのテストがあるか
- 主要なユースケースがカバーされているか
- 期待される出力が明確に検証されているか

### Step 2: 異常系チェック（20点）
- エラー入力に対するテストがあるか
- 例外・エラーハンドリングのテストがあるか
- 無効な状態に対するテストがあるか

### Step 3: 境界値チェック（20点）
- 最小値/最大値のテストがあるか
- 空/null/undefinedのテストがあるか
- 境界条件（0, 1, N-1, N, N+1等）のテストがあるか

### Step 4: 要件対応チェック（20点）
- ビジネス要件・受け入れ基準との対応が明確か
- Issue/仕様に記載された条件がテストされているか
- テストケース名から意図が読み取れるか

### Step 5: 品質特性チェック（20点）
- テストがリファクタリングに耐えられるか（実装詳細に依存していないか）
- テストの保守性は高いか（AAAパターン、適切な命名）
- テストの意図が明確で、失敗時に原因がわかりやすいか

## コンテキスト

{issue_content}

## 対象テストファイル

{test_file_content}

## 対応する実装ファイル（存在する場合）

{impl_file_content}

## 出力フォーマット（厳守）

以下の形式で結果を出力してください：

## 🔍 REVIEW Phase 完了

**評価結果**:

| Step | 観点 | スコア | 状態 |
|------|------|--------|------|
| 1 | 正常系 | __/20 | ✅/⚠️/❌ |
| 2 | 異常系 | __/20 | ✅/⚠️/❌ |
| 3 | 境界値 | __/20 | ✅/⚠️/❌ |
| 4 | 要件対応 | __/20 | ✅/⚠️/❌ |
| 5 | 品質特性 | __/20 | ✅/⚠️/❌ |

**総合スコア**: __/100点

**判定**: ✅ PASS / ⚠️ 要改善 / ❌ 要見直し

**改善が必要な場合**:
- {追加すべきテストケース}
- {修正すべき点}
```

### plan-review（計画レビュー）

```
あなたは実装計画のレビュー専門家です。以下の実装計画を5観点から評価してください。

## 評価基準（5観点、各20点）

### 受け入れ基準との整合性（20点）
- Issueに記載された受け入れ基準をすべてカバーしているか
- 要件の解釈に誤りがないか
- スコープが適切か（過剰でも不足でもない）

### タスク粒度（20点）
- 各タスクは明確で実行可能か
- タスクのサイズは適切か（大きすぎ/小さすぎない）
- タスク間の依存関係は明確か

### 影響範囲の網羅性（20点）
- 変更が影響するファイル/モジュールをすべて把握しているか
- 副作用の考慮はあるか
- 関連する既存機能への影響は検討されているか

### テスト計画の妥当性（20点）
- 受け入れ基準に対応するテストが計画されているか
- エッジケースは考慮されているか
- テスト可能な形で計画されているか

### アーキテクチャ整合性（20点）
- 既存のコーディングパターンに従っているか
- プロジェクトの規約に準拠しているか
- 技術選定は適切か

## コンテキスト（Issue内容）

{issue_content}

## レビュー対象の実装計画

{plan_content}

## 出力フォーマット（厳守）

## 計画レビュー結果

**総合スコア**: XX/100点

| 観点 | スコア | 状態 |
|------|--------|------|
| 受け入れ基準整合性 | XX/20 | ✅/⚠️/❌ |
| タスク粒度 | XX/20 | ✅/⚠️/❌ |
| 影響範囲網羅性 | XX/20 | ✅/⚠️/❌ |
| テスト計画妥当性 | XX/20 | ✅/⚠️/❌ |
| アーキテクチャ整合性 | XX/20 | ✅/⚠️/❌ |

### 問題点・懸念事項
1. [Critical] {問題}
2. [Warning] {懸念}
3. [Info] {提案}

### 改善提案
- {具体的な修正案}

### 判定
- **80点以上**: ✅ 実装開始OK
- **60-79点**: ⚠️ 修正後に再レビュー推奨
- **60点未満**: ❌ 計画の見直しが必要
```

### code-review（軽量コードレビュー）

```
あなたはコードレビューの専門家です。以下のコード変更を4観点から評価してください。

## 評価基準（4観点、各25点）

### セキュリティ（25点）
- 入力バリデーションは適切か
- SQLインジェクション、XSS等の脆弱性はないか
- 認証・認可の実装は正しいか
- シークレット情報がハードコードされていないか

### パフォーマンス（25点）
- N+1問題がないか
- 不要なクエリや処理がないか
- メモリ効率は適切か
- キャッシュ戦略は考慮されているか

### 保守性（25点）
- 命名規約に従っているか
- DRY原則を守っているか
- 単一責任の原則を守っているか
- 関数・メソッドの長さは適切か

### テスト（25点）
- テストカバレッジは十分か
- エッジケースをカバーしているか
- テストは独立して実行可能か
- テストの意図が明確か

## コンテキスト

{issue_content}

## レビュー対象のコード変更

{diff_content}

## 出力フォーマット（厳守）

## レビュー結果

**総合スコア**: XX/100点

### 問題点
1. [Critical] {問題} - {ファイル:行}
2. [Warning] {問題} - {ファイル:行}
3. [Info] {提案} - {ファイル:行}

### 改善提案
- {具体的な修正案}
```

### progressive-review（詳細コードレビュー）

```
あなたはコードレビューの専門家です。以下のコード変更を4ステップで段階的にレビューしてください。
各ステップでは1つの観点だけに集中して評価してください。

## Step 1: セキュリティチェック（25点）

以下のみに集中：
- 入力バリデーションは適切か
- SQLインジェクション、XSS等の脆弱性はないか
- 認証・認可の実装は正しいか
- シークレット情報がハードコードされていないか
- 依存関係に既知の脆弱性はないか

## Step 2: パフォーマンスチェック（25点）

以下のみに集中：
- N+1問題がないか
- 不要なデータベースクエリがないか
- メモリリークの可能性はないか
- 非効率なループや処理がないか
- キャッシュ戦略は適切か

## Step 3: 保守性チェック（25点）

以下のみに集中：
- 命名規約に従っているか
- DRY原則を守っているか
- 単一責任の原則を守っているか
- 関数・メソッドの長さは適切か（50行以下推奨）
- 適切なコメントがあるか（過剰でないか）

## Step 4: テストチェック（25点）

以下のみに集中：
- テストカバレッジは80%以上か
- エッジケースをカバーしているか
- テストは独立して実行可能か
- テストの意図が明確か
- モックの使用は適切か

## コンテキスト

{issue_content}

## レビュー対象のコード変更

{diff_content}

## 出力フォーマット（厳守）

# Progressive Review 最終レポート

## 総合スコア: XX/100点

| 観点 | スコア | 状態 |
|------|--------|------|
| セキュリティ | XX/25 | ✅/⚠️/❌ |
| パフォーマンス | XX/25 | ✅/⚠️/❌ |
| 保守性 | XX/25 | ✅/⚠️/❌ |
| テスト | XX/25 | ✅/⚠️/❌ |

## 各ステップの詳細

### セキュリティチェック結果
**スコア**: XX/25点
- {検出された問題}
- {推奨事項}

### パフォーマンスチェック結果
**スコア**: XX/25点
- {検出された問題}
- {推奨事項}

### 保守性チェック結果
**スコア**: XX/25点
- {検出された問題}
- {推奨事項}

### テストチェック結果
**スコア**: XX/25点
- {検出された問題}
- {推奨事項}

## 判定

- **80点以上**: ✅ 承認推奨
- **60-79点**: ⚠️ 軽微な修正後に承認
- **60点未満**: ❌ 要修正

## 優先度の高い問題 (Top 5)

1. {問題} - {ファイル:行}
2. {問題} - {ファイル:行}
...

## 次のアクション

- [ ] {具体的な修正タスク}
```

---

## Security Considerations

- `--sandbox read-only` により、Codexがファイルを変更することを防止
- Issue内容・コードがOpenAI APIに送信される点は、Codex利用の前提として許容
- `.env`、`credentials.json` 等の機密ファイルは対象ファイルに含めない
- 対象ファイルは明示的に指定し、意図しないファイルが送信されることを防ぐ

## Model Recommendation

| 項目 | 内容 |
|------|------|
| **推奨モデル** | Codex CLI（GPT系モデル） |
| **フォールバック** | Claude Code（Sonnet/Haiku、各レビューの推奨に準拠） |
| **タスク複雑度** | レビュータイプにより異なる |
| **必要コンテキスト** | Issue内容 + 対象ファイル |

### 根拠

- レビュータスクは独立した評価タスクであり、外部モデルへの委任が容易
- Codexは一発成功率が高く、コードレビューでの正確性に優れる（ナレッジ 20260121_ef7694）
- ローカルSkill方式により進捗可視性・制御性が確保される（ナレッジ 20260123_781ecc）
- トークン消費をClaude CodeからCodexに移管することで、レートリミット対策となる
