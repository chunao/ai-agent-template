---
name: progressive-review
description: 段階的コードレビューのワークフローです。複数の観点（セキュリティ、パフォーマンス、保守性、テスト）から順次レビューを行い、各ステップでAIの注意力を集中させることで高品質なレビューを実現します。ユーザーが「レビューして」「PRをチェックして」「コードを確認して」と言ったときに使用します。
---

# Progressive Review Workflow

## Overview

複数の指示をまとめて渡すとAIの精度が落ちるため、**1ステップずつ順次実行**することでレビュー品質を向上させます。

## Workflow Steps

以下の4ステップを**必ず順番に**実行してください。各ステップ完了後、結果をユーザーに報告してから次へ進みます。

---

### Step 1: セキュリティチェック

**目的**: 脆弱性やセキュリティリスクの検出

**チェック項目**:
- [ ] 入力バリデーションは適切か
- [ ] SQLインジェクション、XSS等の脆弱性はないか
- [ ] 認証・認可の実装は正しいか
- [ ] シークレット情報がハードコードされていないか
- [ ] 依存関係に既知の脆弱性はないか

**出力形式**:
```markdown
## セキュリティチェック結果

**スコア**: XX/25点

### 検出された問題
- [ ] {問題の説明} - {該当ファイル:行番号}

### 推奨事項
- {改善提案}
```

**完了条件**: 問題をすべてリストアップし、スコアを算出したら Step 2 へ

---

### Step 2: パフォーマンスチェック

**目的**: パフォーマンス問題の検出

**チェック項目**:
- [ ] N+1問題がないか
- [ ] 不要なデータベースクエリがないか
- [ ] メモリリークの可能性はないか
- [ ] 非効率なループや処理がないか
- [ ] キャッシュ戦略は適切か

**出力形式**:
```markdown
## パフォーマンスチェック結果

**スコア**: XX/25点

### 検出された問題
- [ ] {問題の説明} - {該当ファイル:行番号}

### 推奨事項
- {改善提案}
```

**完了条件**: 問題をすべてリストアップし、スコアを算出したら Step 3 へ

---

### Step 3: 保守性チェック

**目的**: コードの保守性・可読性の評価

**チェック項目**:
- [ ] 命名規約に従っているか
- [ ] DRY原則を守っているか（重複コードがないか）
- [ ] 単一責任の原則を守っているか
- [ ] 関数・メソッドの長さは適切か（50行以下推奨）
- [ ] 適切なコメントがあるか（過剰でないか）

**出力形式**:
```markdown
## 保守性チェック結果

**スコア**: XX/25点

### 検出された問題
- [ ] {問題の説明} - {該当ファイル:行番号}

### 推奨事項
- {改善提案}
```

**完了条件**: 問題をすべてリストアップし、スコアを算出したら Step 4 へ

---

### Step 4: テストチェック

**目的**: テストカバレッジと品質の評価

**チェック項目**:
- [ ] テストカバレッジは80%以上か
- [ ] エッジケースをカバーしているか
- [ ] テストは独立して実行可能か
- [ ] テストの意図が明確か
- [ ] モックの使用は適切か

**出力形式**:
```markdown
## テストチェック結果

**スコア**: XX/25点

### 検出された問題
- [ ] {問題の説明} - {該当ファイル:行番号}

### 推奨事項
- {改善提案}
```

**完了条件**: 問題をすべてリストアップし、スコアを算出したら最終レポートへ

---

## Final Report

全ステップ完了後、以下の形式で最終レポートを作成します。

```markdown
# Progressive Review 最終レポート

## 総合スコア: XX/100点

| 観点 | スコア | 状態 |
|------|--------|------|
| セキュリティ | XX/25 | ✅/⚠️/❌ |
| パフォーマンス | XX/25 | ✅/⚠️/❌ |
| 保守性 | XX/25 | ✅/⚠️/❌ |
| テスト | XX/25 | ✅/⚠️/❌ |

## 判定

- **80点以上**: ✅ 承認推奨
- **60-79点**: ⚠️ 軽微な修正後に承認
- **60点未満**: ❌ 要修正

## 優先度の高い問題 (Top 5)

1. {問題} - {ファイル:行}
2. {問題} - {ファイル:行}
...

## 次のアクション

- [ ] {具体的な修正タスク}
```

## Model Recommendation

| 項目 | 内容 |
|------|------|
| **推奨モデル** | Sonnet |
| **代替候補** | Opus（アーキテクチャ判断を含む重要PR） |
| **タスク複雑度** | 高 |
| **必要コンテキスト** | コード全体 + アーキテクチャ理解 |

### 根拠

- Progressive Pattern により1観点ずつ深い分析を行うため、高い推論能力が必要
- セキュリティ脆弱性、パフォーマンス問題、設計品質の判断には Sonnet 以上が必要
- `/review` コマンドのメインワークフローとして品質を担保する最終レビューの役割を担う
- Codex委任（Issue #45）の有力候補。独立した評価タスクで明確な評価基準がある

### Relationship with reviewer.md

本スキル（progressive-review）と reviewer.md エージェントの使い分け：

| 項目 | progressive-review | reviewer.md |
|------|-------------------|------------|
| **用途** | メインワークフローの詳細レビュー | サブエージェントとして呼び出される軽量レビュー |
| **呼び出し元** | `/review` コマンドから直接 | Task ツールで `general-purpose` subagent として |
| **評価方式** | 4観点を段階的に1つずつ評価（Progressive Pattern） | 4観点を一括評価 |
| **精度** | 高（1観点集中による精度向上） | 標準 |
| **推奨シーン** | PR前の最終レビュー | 簡易チェック、CI内レビュー |

## 80点ルール

- **80点以上**: 前進を推奨（完璧を求めすぎない）
- **80点未満**: 修正後に再レビュー

## Usage Example

```
User: このPRをレビューして

Agent:
1. [Step 1] セキュリティチェックを開始します...
   → 結果報告
2. [Step 2] パフォーマンスチェックを開始します...
   → 結果報告
3. [Step 3] 保守性チェックを開始します...
   → 結果報告
4. [Step 4] テストチェックを開始します...
   → 結果報告
5. [Final] 最終レポートを作成します...
```
