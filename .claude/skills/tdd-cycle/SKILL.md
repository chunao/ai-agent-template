---
name: tdd-cycle
description: TDD（テスト駆動開発）のワークフローです。Red-Review-Green-Refactorサイクルを実行し、テストの「質」も担保するテストファースト開発を支援します。ユーザーが「TDDで開発して」「テスト駆動で実装して」「/tdd」と言ったときに使用します。
---

# TDD Cycle Workflow

## Overview

TDD (Test-Driven Development) の4ステップを**厳密に順序通り**実行します。
各フェーズをスキップせず、必ず順番に完了させてください。

> **Note**: REVIEWフェーズはテストの「質」を担保するために追加されました。
> Progressive Patternにより、1観点ずつ集中して評価することで高精度なレビューを実現します。

## The TDD Mantra

```
🔴 RED    → テストを書く（失敗する）
🔍 REVIEW → テスト項目の妥当性を評価（80点以上で次へ）
🟢 GREEN  → 最小限のコードで通す
🔵 REFACTOR → コードを改善する
```

---

## Phase 1: 🔴 RED - テストを書く

**目的**: 実装したい機能の仕様をテストコードで表現する

### 手順

1. **仕様の明確化**
   - ユーザーに機能の要件を確認
   - 入力と期待される出力を明確にする
   - エッジケースを洗い出す

2. **テストコードの作成**
   ```
   - テストファイルを作成（例: test_機能名.py）
   - テストケースを実装
   - 意図が明確な命名を使用
   ```

3. **テストの実行（失敗を確認）**
   ```bash
   # Python
   pytest test_機能名.py -v

   # JavaScript
   npm test
   ```

### 完了条件

- [ ] テストが**失敗する**ことを確認
- [ ] 失敗理由が「実装がない」であること（構文エラーではない）

### 出力形式

```markdown
## 🔴 RED Phase 完了

**作成したテスト**: {ファイルパス}

**テストケース**:
- `test_xxx`: {テストの意図}
- `test_yyy`: {テストの意図}

**実行結果**: ❌ FAILED (expected)
- {失敗したテスト数} / {全テスト数} 失敗

→ REVIEW Phase へ進みます
```

---

## Phase 1.5: 🔍 REVIEW - テスト項目の妥当性評価

**目的**: 作成したテストが十分な品質を持っているかを評価する

### なぜREVIEWフェーズが必要か

- テストの「量」（カバレッジ）だけでなく「質」を担保する
- Progressive Pattern により、1観点ずつ集中して評価することで精度向上
- 不十分なテストのまま実装に進むことを防ぐ

### 評価方法: Progressive Pattern（5ステップ）

⚠️ **重要**: 各ステップは**1つの観点だけに集中**して評価してください。複数の観点を同時に評価すると精度が落ちます。

#### Step 1: 正常系チェック（20点）

この観点だけに集中して評価してください：

- [ ] 基本的な成功パスのテストがあるか
- [ ] 主要なユースケースがカバーされているか
- [ ] 期待される出力が明確に検証されているか

**スコア**: ___/20点

#### Step 2: 異常系チェック（20点）

この観点だけに集中して評価してください：

- [ ] エラー入力に対するテストがあるか
- [ ] 例外・エラーハンドリングのテストがあるか
- [ ] 無効な状態に対するテストがあるか

**スコア**: ___/20点

#### Step 3: 境界値チェック（20点）

この観点だけに集中して評価してください：

- [ ] 最小値/最大値のテストがあるか
- [ ] 空/null/undefinedのテストがあるか
- [ ] 境界条件（0, 1, N-1, N, N+1等）のテストがあるか

**スコア**: ___/20点

#### Step 4: 要件対応チェック（20点）

この観点だけに集中して評価してください：

- [ ] ビジネス要件・受け入れ基準との対応が明確か
- [ ] Issue/仕様に記載された条件がテストされているか
- [ ] テストケース名から意図が読み取れるか

**スコア**: ___/20点

#### Step 5: 品質特性チェック（20点）

この観点だけに集中して評価してください：

- [ ] テストがリファクタリングに耐えられるか（実装詳細に依存していないか）
- [ ] テストの保守性は高いか（AAAパターン、適切な命名）
- [ ] テストの意図が明確で、失敗時に原因がわかりやすいか

**スコア**: ___/20点

### 判定基準（80点ルール）

| 総合スコア | 判定 | アクション |
|-----------|------|-----------|
| **80点以上** | ✅ PASS | GREEN Phase へ進む |
| **60-79点** | ⚠️ 要改善 | 不足しているテストを追加し、再評価 |
| **60点未満** | ❌ 要見直し | テスト設計を根本から見直す |

### 完了条件

- [ ] 5ステップすべての評価が完了
- [ ] 総合スコアが**80点以上**

### 出力形式

```markdown
## 🔍 REVIEW Phase 完了

**評価結果**:

| Step | 観点 | スコア | 状態 |
|------|------|--------|------|
| 1 | 正常系 | __/20 | ✅/⚠️/❌ |
| 2 | 異常系 | __/20 | ✅/⚠️/❌ |
| 3 | 境界値 | __/20 | ✅/⚠️/❌ |
| 4 | 要件対応 | __/20 | ✅/⚠️/❌ |
| 5 | 品質特性 | __/20 | ✅/⚠️/❌ |

**総合スコア**: __/100点

**判定**: ✅ PASS / ⚠️ 要改善 / ❌ 要見直し

**改善が必要な場合**:
- {追加すべきテストケース}
- {修正すべき点}

→ GREEN Phase へ進みます
```

---

## Phase 2: 🟢 GREEN - テストを通す

**目的**: テストを通す**最小限の**コードを書く

### 重要なルール

⚠️ **このフェーズでやること**:
- テストを通すことだけに集中
- 最小限のコードを書く
- 動くコードを書く

⚠️ **このフェーズでやらないこと**:
- コードの美しさを追求しない
- 将来の拡張を考えない
- リファクタリングしない

### 手順

1. **最小限の実装**
   - テストが通る最もシンプルなコードを書く
   - ハードコードでも構わない（後でリファクタリング）

2. **テストの実行（成功を確認）**
   ```bash
   # Python
   pytest test_機能名.py -v

   # JavaScript
   npm test
   ```

### 完了条件

- [ ] すべてのテストが**成功する**こと
- [ ] 新規のテスト失敗がないこと

### 出力形式

```markdown
## 🟢 GREEN Phase 完了

**実装したファイル**: {ファイルパス}

**実行結果**: ✅ PASSED
- {成功したテスト数} / {全テスト数} 成功

**実装の概要**:
- {何を実装したか}

→ REFACTOR Phase へ進みます
```

---

## Phase 3: 🔵 REFACTOR - コードを改善する

**目的**: テストを壊さずにコードを改善する

### 重要なルール

⚠️ **このフェーズでやること**:
- コードの重複を排除
- 命名を改善
- 構造を整理
- 可読性を向上

⚠️ **このフェーズでやらないこと**:
- 新機能を追加しない
- テストを変更しない（リファクタリングのためのテスト追加は可）

### チェックリスト

- [ ] 重複コードはないか
- [ ] 命名は適切か
- [ ] 関数は単一責任か
- [ ] コメントは必要最小限か
- [ ] テストは依然として通るか

### 手順

1. **コードの改善**
   - 1つずつ小さな改善を行う
   - 改善のたびにテストを実行

2. **テストの実行（成功を維持）**
   ```bash
   pytest test_機能名.py -v
   ```

### 完了条件

- [ ] リファクタリング完了
- [ ] すべてのテストが**成功する**こと

### 出力形式

```markdown
## 🔵 REFACTOR Phase 完了

**改善内容**:
- {改善1}
- {改善2}

**実行結果**: ✅ PASSED
- {成功したテスト数} / {全テスト数} 成功

---

## 🎉 TDD Cycle 完了

**サマリー**:
- テストケース数: {N}
- カバレッジ: {X}% (目標: 80%以上)
- 実装ファイル: {ファイルリスト}

**次のアクション**:
- [ ] 次の機能のTDDサイクルを開始
- [ ] または、実装完了
```

---

## Cycle Continuation

1つの機能が完了したら：

1. **追加機能がある場合** → Phase 1 (RED) に戻る
2. **完了の場合** → 最終サマリーを出力

```markdown
## TDD Session 完了

**実装した機能**:
1. {機能1}
2. {機能2}

**総テストケース数**: {N}
**最終カバレッジ**: {X}%

**作成されたファイル**:
- {ファイル1}
- {ファイル2}
```

---

## Usage Example

```
User: ユーザー認証機能をTDDで実装して

Agent:
🔴 [RED] テストを書きます...
   - test_user_login_with_valid_credentials
   - test_user_login_with_invalid_password
   → テスト失敗を確認 ✓

🔍 [REVIEW] テスト項目を評価します...
   - Step 1: 正常系 → 18/20点
   - Step 2: 異常系 → 16/20点
   - Step 3: 境界値 → 14/20点 → 空文字テスト追加
   - Step 4: 要件対応 → 18/20点
   - Step 5: 品質特性 → 16/20点
   → 総合: 82/100点 ✅ PASS

🟢 [GREEN] 最小限の実装をします...
   - login関数を実装
   → テスト成功を確認 ✓

🔵 [REFACTOR] コードを改善します...
   - パスワードハッシュ化を関数に抽出
   - エラーメッセージを定数化
   → テスト成功を維持 ✓

🎉 TDD Cycle 完了！
```

## Model Recommendation (REVIEW Phase)

| 項目 | 内容 |
|------|------|
| **推奨モデル** | Haiku |
| **代替候補** | Sonnet（複雑なビジネスロジックのテスト評価時） |
| **タスク複雑度** | 低〜中 |
| **必要コンテキスト** | テストファイル + 対応する実装ファイル |

### 根拠

- REVIEWフェーズはチェックリスト的評価であり、各ステップの判断基準が明確に定義されている
- テストファイルに限定されたコンテキストで動作するため、高度なコンテキスト理解は不要
- 5ステップの評価観点が構造化されており、機械的に判断可能な部分が多い
- Codex委任（Issue #45）の最有力候補。評価基準が明確かつ定量的で、コンテキストが限定的

### 実行方式方針

**方針: メインエージェント内で実行（現状維持）**

TDD REVIEW は以下の理由からサブエージェント分離を行わず、メインエージェント内で実行する：

1. テスト作成直後に即座に評価するフローであり、サブエージェント分離するとコンテキスト受け渡しのオーバーヘッドが大きい
2. RED Phase で作成したテストの意図を理解した上で評価するため、コンテキスト共有が重要
3. Issue #45 でCodex委任を検討する際は、tdd-cycle全体のフロー見直しと合わせて判断する

## Tips

- **小さく始める**: 最初のテストは最もシンプルなケースから
- **1つずつ**: 一度に複数の機能を追加しない
- **頻繁に実行**: テストは数秒で実行できるようにする
- **失敗を歓迎**: REDフェーズでの失敗は正常な状態
- **1観点に集中**: REVIEWフェーズでは各ステップで1つの観点だけを評価（Progressive Pattern）
- **80点で前進**: 完璧を求めすぎず、80点以上で次へ進む
