---
name: knowledge-retrieval
description: ユーザーが「方法」についてのガイダンスやベストプラクティスを求めている場合、または過去の知識やアーカイブされた例（`knowledge/index.json`から）が有益である可能性のある複雑なタスクに直面している場合に、このスキルを使用してください。このスキルにより、過去にアーカイブされた記事を発見し活用することができます。
---

# Knowledge Retrieval (ナレッジ検索)

## 概要

このスキルは、ローカルにアーカイブされた技術記事を「参考情報」として活用するためのものです。Gemini APIにナレッジ検索を委譲することで、メインエージェントのコンテキストウィンドウを節約します。

### 前提条件

- `GEMINI_API_KEY` 環境変数が設定されていること（`.env` ファイルまたは環境変数）
- Python 3.11以上がインストールされていること
- `google-generativeai` パッケージがインストールされていること（`uv sync` で自動インストール）

### 基本方針

- **メインエージェントの知識を第一に**: タスクの実行は、あなた自身の知識とベストプラクティスを基盤として進めてください
- **ローカルナレッジは参考情報**: アーカイブされた記事は「こういう手段も世の中にはあるんだな」という参考程度の位置づけです
- **選択的な適用**: 「なるほど、これは使えそうな情報だ」と判断したものについてのみ、その知見をあなたの判断に組み込んでください
- **絶対視しない**: ローカルナレッジに記載されている方法が唯一の解決策ではありません。あなた自身の判断を優先してください

## ワークフロー

### ステップ 1: Gemini APIによるナレッジ検索（コンテキスト節約）

**重要**: メインエージェントは `index.json` を読み込みません。代わりに、Gemini APIにナレッジ検索タスクを委譲します。これにより、メインエージェントのコンテキストウィンドウを節約できます。

以下のコマンドを実行して、Gemini APIに検索を依頼します：

```powershell
uv run python .claude/skills/knowledge-retrieval/scripts/search_with_gemini.py --request "[ここにユーザーの質問やタスク内容を記述]" --max 5
```

**注意事項**:
- `[ここにユーザーの質問やタスク内容を記述]` の部分を、実際のユーザーリクエストに置き換えてください
- 引用符内に二重引用符が含まれる場合は、適切にエスケープしてください
- `GEMINI_API_KEY` 環境変数が設定されていない場合はエラーメッセージが表示されます

**エラー時のフォールバック**:
- `GEMINI_API_KEY` が未設定の場合: ユーザーにAPIキーの設定を依頼してください
- API呼び出しが失敗した場合: ネットワーク接続を確認してリトライしてください
- 120秒以上応答がない場合: ユーザーに状況を報告してください

### ステップ 2: IDリストの抽出

Claude CLIの出力から、`SELECTED_ARTICLE_IDS:` セクション以降の行を抽出し、各行から記事ID（`YYYYMMDD_XXXXXX` 形式）を取得します。

**期待される出力**:
```
SELECTED_ARTICLE_IDS:
- 20260120_a1cce2
- 20260121_63d325
- 20260121_555780
```

正規表現 `\d{8}_[a-f0-9]{6}` でIDを抽出できます。

### ステップ 3: コンテンツの取得

抽出したIDの記事のみを読み込みます。これにより、必要最小限のコンテキスト消費で済みます。

```python
view_file(AbsolutePath="d:/projects/P010/knowledge/archive/20260120_a1cce2.md")
view_file(AbsolutePath="d:/projects/P010/knowledge/archive/20260121_63d325.md")
view_file(AbsolutePath="d:/projects/P010/knowledge/archive/20260121_555780.md")
```

### ステップ 4: ナレッジの参考活用（選択的適用）

取得した記事を読み、以下の観点で評価してください：

**評価のポイント**:
- この情報は現在のタスクに本当に有用か？
- あなた自身の知識と矛盾していないか？比較してどちらが適切か？
- 記事の情報は最新か？（`published_at` を確認）
- この手法は現在の状況に適用可能か？

**有用と判断した場合の活用方法**:
- 解決策や計画の「一つの選択肢」として考慮する
- ベストプラクティスを参考にしつつ、状況に応じてカスタマイズする
- 既知の落とし穴（失敗モード）があれば、回避策を検討する
- 運用コストや前提条件を理解した上で、採用するか判断する

**注意**: アーカイブされた記事は「こういうアプローチもある」という参考情報です。あなた自身の知識とベストプラクティスを第一に考え、有用と判断したもののみを組み込んでください。

## 重要な注意点

-   **あなたの知識を第一に**: このスキルは補助的なツールです。あなた自身の知識、ベストプラクティス、判断力を最優先してください。
-   **コンテキスト分離の利点**: このワークフローでは、メインエージェントは `index.json`（約88KB）を一切読み込みません。Gemini APIが別コンテキストで処理するため、メインエージェントのコンテキストウィンドウを100%節約できます。
-   **AI検索の信頼性**: Gemini 2.0 Flashは1Mトークンのコンテキストウィンドウを持ち、index.json全体を総合的に分析できます。タグの表記ゆれ（例: "MCP" と "Model Context Protocol"）も適切に認識します。
-   **選択的な参照**: Gemini APIが選択した記事IDのみを読み込みます。通常3〜5件の記事に絞り込まれるため、必要最小限のコンテキスト消費で済みます。これらの記事はあくまで「こういう手段もあるんだな」という参考情報です。
-   **鮮度の確認**: `published_at` の日付を確認してください。古い記事には時代遅れの情報が含まれている可能性があります。あなた自身の判断を使用してください。
-   **一つの参考例**: アーカイブされたナレッジは、物事を行うための*一つの*方法（例）を表しており、必ずしも*唯一の*または*絶対的に最良の*方法ではありません。あなた自身の知識と比較し、有用と判断したもののみを採用してください。

## 使用例

### 例1: Claude Codeの並列実行について知りたい場合

**ユーザーリクエスト**: "Claude Codeで複数のタスクを並列実行する方法を教えて"

**実行コマンド**:
```powershell
uv run python .claude/skills/knowledge-retrieval/scripts/search_with_gemini.py --request "Claude Codeで複数のタスクを並列実行する方法を教えて" --max 5
```

**出力例**:
```
20260120_a1cce2
20260121_f9e324
20260121_1153aa
```

**記事の読み込み**:
```python
view_file(AbsolutePath="d:/projects/P010/knowledge/archive/20260120_a1cce2.md")
view_file(AbsolutePath="d:/projects/P010/knowledge/archive/20260121_f9e324.md")
view_file(AbsolutePath="d:/projects/P010/knowledge/archive/20260121_1153aa.md")
```

### 例2: MCPについて知りたい場合

**ユーザーリクエスト**: "MCPサーバーの実装方法を知りたい"

**実行コマンド**:
```powershell
uv run python .claude/skills/knowledge-retrieval/scripts/search_with_gemini.py --request "MCPサーバーの実装方法を知りたい" --max 5
```

**出力例**:
```
20260121_3808a9
20260121_61630a
20260120_c13016
```


